[tools]
go = "1.24"
golangci-lint = "1.64.8"
svu = "3.3.0"

[tasks.fmt]
description = "Format Go source files"
run = "gofmt -w ./src"

[tasks.fmt-check]
description = "Check Go source formatting"
run = """
out="$(gofmt -l ./src)"
if [ -n "$out" ]; then
  printf 'gofmt needed for:\n%s\n' "$out"
  exit 1
fi
"""

[tasks.vet]
description = "Run go vet"
run = "go -C src vet ./..."

[tasks.lint]
description = "Run lint checks"
depends = ["vet"]
run = "cd src && golangci-lint run ./..."

[tasks.test]
description = "Run all tests"
run = "go -C src test ./..."

[tasks.ci]
description = "Run CI quality gates"
depends = ["fmt-check", "lint", "test"]
run = "printf 'All CI checks passed.\n'"

[tasks.release]
description = "Create and push the next release tag (CI publishes artifacts)"
depends = ["ci"]
run = """
set -eu

git diff --quiet && git diff --cached --quiet || {
  printf 'Working tree is dirty. Commit or stash changes before releasing.\n'
  exit 1
}

git fetch --tags origin

current="$(svu current --tag.prefix v --tag.mode all)"
next="$(svu next --tag.prefix v --tag.mode all)"

if [ "$next" = "$current" ]; then
  printf 'No releasable commits found since %s (need feat/fix/breaking).\n' "$current"
  exit 1
fi

if git rev-parse --verify "$next" >/dev/null 2>&1; then
  printf 'Tag already exists locally: %s\n' "$next"
  exit 1
fi

git tag -a "$next" -m "release: $next"
git push origin "$next"

printf 'Pushed %s. GitHub Actions release workflow should start now.\n' "$next"
"""

[tasks.bench]
description = "Run benchmark suite"
run = "go -C src test ./... -bench . -benchmem"

[tasks.build]
description = "Build local snav binary"
run = "mkdir -p bin && go -C src build -buildvcs=false -o ../bin/snav ."

[tasks.build-macos-arm64]
description = "Build macOS arm64 snav binary"
run = "mkdir -p bin && GOOS=darwin GOARCH=arm64 go -C src build -buildvcs=false -o ../bin/snav ."

[tasks.link]
description = "Build macOS arm64 binary and install to ~/.local/bin"
depends = ["build-macos-arm64"]
run = "mkdir -p \"$HOME/.local/bin\" && install -m 0755 bin/snav \"$HOME/.local/bin/snav\""

[tasks.dev]
description = "Run snav via go run"
raw = true
run = "go -C src run ."

[tasks.cli]
description = "Build and run local binary (interactive)"
depends = ["build"]
raw = true
run = "./bin/snav"

[tasks.clean]
description = "Remove local build output"
run = "rm -rf bin"
